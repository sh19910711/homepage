<script src="./dist/amazon-cognito-identity.min.js"></script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.483.0.min.js"></script>
<h1>edit</h1>
<script>
function run() {
    function signIn(authenticationData, callback) {
      function getUser() {
        const poolData = {
          UserPoolId: 'us-east-1_ngme'+'RQd9I',
          ClientId: '25aec8e'+'om6fb4v9js2pusfmq1v'
        };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        const userData = {
            Username: authenticationData.Username,
            Pool: userPool
        };
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

        return cognitoUser;
      }

      const user = getUser();
      const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
      user.authenticateUser(authenticationDetails, {
          onSuccess: function (result) {
              var accessToken = result.getAccessToken().getJwtToken();

              //POTENTIAL: Region needs to be set if not already set previously elsewhere.
              AWS.config.region = 'us-east-1';

              AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                  IdentityPoolId: 'us-east-1:094c8'+'067-7acc-4113-a390-ad8c542f6af8', // your identity pool id here
                  Logins: {
                      // Change the key below according to the specific region your user pool is in.
                      'cognito-idp.us-east-1.amazonaws.com/us-east-1_ngmeRQd9I' : result.getIdToken().getJwtToken()
                  }
              });

              //refreshes credentials using AWS.CognitoIdentity.getCredentialsForIdentity()
              AWS.config.credentials.refresh((error) => {
                  if (error) {
                       console.error(error);
                  } else {
                       // Instantiate aws sdk service objects now that the credentials have been updated.
                       // example: var s3 = new AWS.S3();
                       console.log('Successfully logged!');
                       callback();
                  }
              });
          },

          onFailure: function(err) {
              console.error(err.message || JSON.stringify(err));
          },

          newPasswordRequired: function(err) {
              if (err) console.error(err);
              user.completeNewPasswordChallenge('O9hAm`G`.dY#>B.++');
          },

      });
    }

    function renderSignIn() {
      function createSignInButton() {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '#hello';
        form.onsubmit = function() { console.log('on signin'); return false };
        const username = document.createElement('input');
        username.name = 'username';
        username.placeholder = 'username';
        const password = document.createElement('input');
        password.type = 'password';
        password.name = 'password';
        password.placeholder = 'password';
        const button = document.createElement('button');
        button.innerText = 'Sign in';
        button.onclick = function() {
          const text = document.createElement('text');
          text.innerText = 'running...';
          document.body.appendChild(text);
          signIn({Username: username.value, Password: password.value}, function() {
            location.hash = 'ping';
          })
        };
        form.appendChild(username);
        form.appendChild(password);
        form.appendChild(button);
        return form;
      }
      document.body.appendChild(createSignInButton());
    }

    function renderIdentity() {
      document.body.appendChild((function() {
        const button = document.createElement('button');
        button.innerText = 'GetCallerIdentity';
        button.onclick = function() {
           const sts = new AWS.STS();
           sts.getCallerIdentity({}, function(err, data) {
             if (err) console.error(err);
             console.log(data);
           });
        };
        return button;
      })());
    }

    function invoke(payload, callback) {
      const lambda = new AWS.Lambda();
      const params = {
        FunctionName: 'homepage-Cognito-9BU351LF6PNT-RubyFunction-7LPKH26K3NNG',
        InvocationType: 'RequestResponse',
        LogType: 'None',
        Payload: payload,
      };
      lambda.invoke(params, callback);
    }

    function renderNotes() {
      document.body.appendChild((function self() {
        const div = document.createElement('div');
        div.innerText = 'loading...';

        const result = document.createElement('div');
        div.appendChild(result);

        invoke(JSON.stringify({
            'type': 'all'
        }), function(err, res) {
          if (err) console.error(err);
          const itemsRaw = JSON.parse(JSON.parse(res.Payload));
          let items = itemsRaw.slice();

          div.appendChild((function() {
            const view = document.createElement('div');
            const input = document.createElement('input');
            const button = document.createElement('button');
            button.innerText = 'Filter!!';
            button.onclick = function() {
              const s = input.value;
              items = itemsRaw.filter(x => x.name.match(s));
              renderList();
            };
            view.appendChild(input);
            view.appendChild(button);
            return view;
          })());

          const ul = document.createElement('ul');

          div.appendChild((function() {
            const button = document.createElement('button');
            button.innerText = 'Select All';
            button.onclick = function() {
              for (let el = ul.firstChild; el; el = el.nextSibling) {
                el.firstChild.checked = !el.firstChild.checked;
              }
            }
            return button;
          })());

          function renderList() {
            while (ul.firstChild) ul.removeChild(ul.firstChild);

            const fragment = document.createDocumentFragment();
            items.forEach(function(item) {
              const li = document.createElement('li');
              li.dataset.note_id = item.note_id;
              li.dataset.name = item.name;
              const label = document.createElement('label');
              label.innerText = item.name;
              const input = document.createElement('input');
              input.type = 'checkbox';
              li.appendChild(input);
              li.appendChild(label);
              fragment.appendChild(li);
            });
            ul.appendChild(fragment);
          }

          renderList();
          div.appendChild(ul);

          div.appendChild((function() {
            const view = document.createElement('div');
            const input = document.createElement('input');
            const button = document.createElement('button');
            button.innerText = 'set tag';
            button.onclick = function() {
              const tags = input.value.split(',');
              const body = [];
              for (let i = 0; i < ul.children.length; ++i) {
                const el = ul.children[i];
                for (let j = 0; j < tags.length; ++j) {
                  body.push({
                    index: {
                      _index: "homepage_note_tags",
                      data: {
                        note_id: ''+el.dataset.note_id,
                        name: ''+el.dataset.name,
                        tag: ''+tags[j],
                      }
                    }
                  });
                }
              }

              sendBulk(body, function(err, res) {
                if (err) console.error(err);
                const result = document.createElement('pre');
                result.innerText = JSON.stringify(JSON.parse(res.Payload), null, "\t");
                view.appendChild(result);
              });
            };
            view.appendChild(input);
            view.appendChild(button);
            return view;
          })());
        });

        return div;
      })());
    }

    function renderTags() {
      console.log('tags');
      const view = document.createElement('div');
      document.body.appendChild(view);

      const params = {
        type: 'search:search',
        params: JSON.stringify({
          index: 'homepage_note_tags',
          size: 10000
        })
      };
      invoke(JSON.stringify(params), function(err, res) {
        if (err) console.error(err);
        const payload = JSON.parse(res.Payload);

        const ul = document.createElement('ul');

        view.appendChild((function() {
          const button = document.createElement('button');
          button.innerText = 'Select All';
          button.onclick = function() {
            for (let el = ul.firstChild; el; el = el.nextSibling) {
              el.firstChild.checked = !el.firstChild.checked;
            }
          };
          return button;
        })());

        view.appendChild((function() {
          const fragment = document.createDocumentFragment();
          const hits = payload.hits.hits;
          for (let i = 0; i < hits.length; ++i) {
            const id = hits[i]['_id'];
            const source = hits[i]['_source'];
            const li = document.createElement('li')
            const input = document.createElement('input');
            input.type = 'checkbox';
            const span = document.createElement('span');
            span.innerText = `${source.tag}: ${source.name} / ${id}`
            li.appendChild(input);
            li.appendChild(span);
            li.dataset.id = id;
            fragment.appendChild(li);
          }
          ul.appendChild(fragment);
          return ul;
        })());

        view.appendChild((function() {
          const view = document.createElement('div');
          const input = document.createElement('input');
          input.type = 'checkbox';
          view.appendChild(input);

          const button = document.createElement('button');
          button.onclick = function() {
            if (!input.checked) {
              alert('please check left box');
              return;
            }

            const body = [];
            for (let el = ul.firstChild; el ; el = el.nextSibling) {
              body.push({
                'delete': {
                  _index: 'homepage_note_tags',
                  _id: el.dataset.id,
                }
              });
            }

            sendBulk(body, function(err, res) {
              if (err) console.error(err);
              const result = document.createElement('pre');
              result.innerText = JSON.stringify(JSON.parse(res.Payload), null, "\t");
              view.appendChild(result);
            });
          };
          button.innerText = 'Delete tags # please check left box';
          view.appendChild(button);
          return view;
        })());
      });
    }

    function renderQuery() {
      document.body.appendChild((function self() {
        const div = document.createElement('div');
        const input = document.createElement('textarea');
        input.placeholder = 'sql here';
        const result = document.createElement('pre');
        const button = document.createElement('button');
        button.innerText = 'Run Query';
        button.onclick = function() {
          invoke(JSON.stringify({
            'type': 'query',
            'sql': input.value
          }), function(err, res) {
            if (err) console.error(err);
            result.innerText = JSON.stringify(JSON.parse(JSON.parse(res.Payload)), null, "\t");
            document.body.appendChild(self());
          });
        };

        div.appendChild(input);
        div.appendChild(document.createElement('br'));
        div.appendChild(button);
        div.appendChild(document.createElement('br'));
        div.appendChild(result);
        return div;
      })());
    }

    function renderPing() {
      document.body.appendChild((function() {
        const div = document.createElement('div');
        div.innerText = 'ping...';
        invoke(JSON.stringify({
          'type': 'ping'
        }, function() {
          div.innerText += ' => pong!!';
          location.hash = '#welcome';
        }));
        return div;
      })());
    }

    function sendBulk(body, callback) {
        invoke(JSON.stringify({
          'type': 'search:bulk',
          'body': JSON.stringify(body)
        }), callback);
    }

    function renderSearchBulk() {
      document.body.appendChild((function self() {
        const div = document.createElement('div');
        const input = document.createElement('textarea');
        input.value = [
          '[',
          '  {"index": {"_index": "homepage_note_tags", "data": {',
          '    "note_id": "4ba462da-f8f7-4a5a-8366-37e2762eb784", "tag": "*aaa"',
          '  }}}',
          ']',
        ].join('\n');
        const result = document.createElement('pre');
        const button = document.createElement('button');
        button.innerText = 'Bulk';
        button.onclick = function() {
          const body = JSON.parse(input.value);
          sendBulk(body, function(err, res) {
            if (err) console.error(err);
            result.innerText = JSON.stringify(JSON.parse(res.Payload), null, "\t");
            document.body.appendChild(self());
          });
        };

        div.appendChild(input);
        div.appendChild(document.createElement('br'));
        div.appendChild(button);
        div.appendChild(document.createElement('br'));
        div.appendChild(result);
        return div;
      })());
    }

    function renderWelcome() {
      document.body.appendChild((function() {
        const div = document.createElement('div');
        div.innerHTML = '';
        div.innerHTML += '<ul>';
        div.innerHTML += '<li><a href="#welcome">welcome</a></li>';
        div.innerHTML += '<li><a href="#notes">all notes</a></li>';
        div.innerHTML += '<li><a href="#tags">all tags</a></li>';
        div.innerHTML += '<li><a href="#query">sql query</a></li>';
        div.innerHTML += '<li><a href="#search:bulk">search: bulk</a></li>';
        div.innerHTML += '<li><a href="#logout">logout</a></li>';
        div.innerHTML += '</ul>';
        return div;
      })());
    }

    function render() {
      console.log('here?');
      if (!AWS.config.credentials) {
        renderSignIn();
        return ;
      }

      console.log(location.hash);
      switch (location.hash) {
        case '#ping':
          renderPing();
          break;
        case '#welcome':
          renderWelcome();
          break;
        case '#query':
          renderQuery();
          break;
        case '#notes':
          renderNotes();
          break;
        case '#tags':
          renderTags();
          break;
        case '#search:bulk':
          renderSearchBulk();
          break;
        default:
          renderSignIn();
          break;
      }
    }

    window.onhashchange = render;
    render();
}

window.onload = run;
</script>
